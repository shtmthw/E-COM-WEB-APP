var structr = require("structr");
structr.mixin(require("structr-step"));
var transports  = require("./transports"),
TransportWrapper = require("./transportWrapper"),
_ = require("underscore"),
Inbound = require("./inbound");

var Emailer = structr({
	"__construct": function(options) {
		this.transport = new TransportWrapper(transports.getTransport(options));
		this.inbound = new Inbound(this);
		this.connectMiddleware = _.bind(this.inbound.handleRequest, this.inbound);
	},
	"send": function(options, callback) {
		this.transport.send(options, callback);
	}
});


module.exports = function(options) {
	return new Emailer(options);
}

module.exports.plugin = function(loader) {
	var emailer   =  module.exports(loader.params("emailer")),
	expressServer = loader.module("plugin-express");

	if(expressServer) expressServer.all("/emailer/inbound/:transport/:command", emailer.connectMiddleware);
	
	return emailer;
}