var structr = require("structr"),
emailify = require("emailify"),
step = require("step"),
outcome = require("outcome");


module.exports = structr({

	"__construct": function(transport) {
		this._transport = transport;
	},

	/**
	 */

	"step send": function(options, callback) {
		
		var self = this, on = outcome.error(callback);

		step(
			function() {
				if(options.textBody) {
					return self._transport.send(options, callback);
				} else 
				if(options.htmlBody) {
					return emailify.parse(options.htmlBody, this);
				} else {
					this(new Error("textBody or htmlBody must be present"));
				}
			},
			on.success(function(body) {
				options.htmlBody = body;
				self._transport.send(options, this);
			}),
			callback
		);
	}
});